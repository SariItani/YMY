<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" href="/static/logo.png" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css"
		/>
		<title>Pending Table</title>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-info">
			<a class="navbar-brand text-dark" href="/"
				><img
					src="/static/logo.png"
					width="32"
					height="32"
					class="d-inline-block align-top mr-2"
					alt=""
				/><b>YMY Agency</b></a
			>
			<button
				class="navbar-toggler"
				type="button"
				data-toggle="collapse"
				data-target="#navbarNav"
				aria-controls="navbarNav"
				aria-expanded="false"
				aria-label="Toggle navigation"
			>
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="nav nav-pills">
					<li class="nav-item active">
						<a class="nav-link text-white" href="/pending-table"
							><b>Pending Table</b><span class="sr-only">(current)</span></a
						>
					</li>
          <li class="nav-item">
						<a class="nav-link text-white" href="/progress-table"
							><b>Progress Table</b><span class="sr-only"></span></a
						>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/departments-table"
                                ><b>Departments Offices</b><span class="sr-only"></span></a
                            >
                        </li>
					</li>
					<li class="nav-item">
						<a class="nav-link text-white" href="/reports"><b>Reports</b></a>
					</li>
					<li class="nav-item">
						<a class="nav-link text-white" href="/entries"><b>Data Entry</b></a>
					</li>
					<li class="nav-item">
						<a class="nav-link text-white" href="/search"><b>Search</b></a>
					</li>
				</ul>
				<ul class="nav nav-pills">
					<form method="POST" class="form-inline">
						<li class="nav-item form-inline">
							<button
								type="submit"
								class="btn btn-info"
								name="logout"
								value="logout"
							>
								<b>Logout</b>
							</button>
						</li>
					</form>
				</ul>
			</div>
		</nav>
    <form method="POST" id="pending-table-form" name="pending-table-form">
      <div class="container mt-4">
          <div class="table-responsive">
              <table id="pending_table" class="table table-striped table-bordered table-info" style="width: 100%">
                  <thead class="thead-dark">
                      <tr>
                          <th>Client Name</th>
                          <th>Type</th>
                          <th>Description</th>
                          <th>Department</th>
                          <th>Due Date</th>
                          <th>Timer</th>
                          <th>Expected Due</th>
                          <th>Select Tutor</th>
                          <th>Confirm Tutor</th>
                          <th>Send Whatsapp</th>
                          <th>Tutors Received</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for project in pending_table %}
                      <tr>
                          <td>{{ project_client_dict[project.id] }}</td>
                          <td>{{ project.type }}</td>
                          <td>{{ project.description }}</td>
                          <td>{{ project.department }}</td>
                          <td>{{ project.due }}</td>
                          <td id="timer" name="timer" data-creation-time="{{ project.created_at }}"></td>
                          <td>
                            <input type="datetime-local" name="expected-due-{{ project.id }}" class="form-control">
                          </td>
                          <td>
                              <select style="width: fit-content; height: auto;" id="selected-tutor-{{ project.id }}" class="form-control">
                                <option value="all" data-id="all" data-phone="">All {{project.department}} Tutors</option>
                                  {% for tutor in tutors %}
                                  {% if tutor.department.lower().strip() == project.department.lower().strip() %}
                                  <option value="{{ tutor.id }}" data-id="{{ tutor.id }}" data-phone="{{ tutor.number }}">{{ tutor.name }}</option>
                                  {% endif %}
                                  {% endfor %}
                              </select>
                              <input type="hidden" name="tutor-phone-{{ project.id }}" id="tutor-phone-{{ project.id }}" />
                              <input type="hidden" name="tutor-id-{{ project.id }}" id="tutor-id-{{ project.id }}" />
                              <input type="hidden" name="project-department-{{ project.id }}" value="{{ project.department }}" />
                          </td>
                          <td>
                            <button class="btn btn-warning text-white" name="send-to-tutor" data-project-id="{{ project.id }}" value="{{project.id}}" onclick="validateTutorSelection('{{ project.id }}')">Confirm Now</button>
                          </td>
                          <td>
                              <button class="btn btn-outline-success" name="whatsapp" data-project-id="{{ project.id }}" value="{{project.id}}" onclick="inputs_hidden('{{ project.id }}')">Send Whatsapp</button>
                          </td>
                          <td>
                            {% if project.tutors_received is none %}
                              None
                            {% elif project.tutors_received %}
                            {% for tutor in tutors %}
                              {% for tutor_id in project.tutors_received %}
                                {% if tutor.id == tutor_id|int %}
                                <b>&#x25cf;</b> {{ tutor.name }} ({{ tutor.id }})
                                {% endif %}
                              {% endfor %}
                              {% endfor %}
                            {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                  </tbody>
                  <tfoot>
                      <tr>
                          <th>Client Name</th>
                          <th>Type</th>
                          <th>Description</th>
                          <th>Department</th>
                          <th>Due Date</th>
                          <th>Timer</th>
                          <th>Expected Due</th>
                          <th>Select Tutor</th>
                          <th>Confirm Tutor</th>
                          <th>Send Whatsapp</th>
                          <th>Tutors Received</th>
                      </tr>
                  </tfoot>
              </table>
          </div>
      </div>
  </form>  
		<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
		<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
		<script>
			$(document).ready(function () {
				$("#pending_table").DataTable();
			});
		</script>
        <script>
            function formatTime(timeInSeconds) {
                var hours = Math.floor(timeInSeconds / 3600);
                var minutes = Math.floor((timeInSeconds % 3600) / 60);
                var seconds = Math.floor(timeInSeconds % 60);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            function updateTimers() {
                var timerElements = document.querySelectorAll('#timer');
                timerElements.forEach(function (timerElement) {
                    const source="https://cdn.freesound.org/previews/437/437687_5487341-lq.mp3";
                    var creationTime = new Date(timerElement.getAttribute('data-creation-time'));
                    var currentTime = new Date();
                    var timeZoneOffset = currentTime.getTimezoneOffset();
                    creationTime.setMinutes(creationTime.getMinutes() - timeZoneOffset);
                    currentTime.setMinutes(currentTime.getMinutes());
                    var elapsedTime = Math.floor((currentTime - creationTime) / 1000);
                    var formattedTime = formatTime(elapsedTime);
                    timerElement.textContent = formattedTime;
                    if (elapsedTime >= 1800 && elapsedTime < 1810) {
                        let audio = new Audio();
                        audio.src=source;
                        audio.play();
                    }
                });
            }
            setInterval(updateTimers, 100);
            
            function getTutorPhoneNumber(projectId) {
                var tutorSelect = document.getElementById(`selected-tutor-${projectId}`);
                var tutorPhone = tutorSelect.options[tutorSelect.selectedIndex].getAttribute('data-phone');
                var tutorPhoneInput = document.getElementById(`tutor-phone-${projectId}`);
                tutorPhoneInput.value = tutorPhone;
                console.log(tutorPhoneInput.value);
            }
            function getTutorID(projectId) {
              var tutorSelect = document.getElementById(`selected-tutor-${projectId}`);
              var tutorId = tutorSelect.options[tutorSelect.selectedIndex].getAttribute(`data-id`);
              var tutorIdInput = document.getElementById(`tutor-id-${projectId}`);
              tutorIdInput.value = tutorId;
              console.log(tutorId);
            }
            function inputs_hidden(projectId) {
              getTutorPhoneNumber(projectId);
              getTutorID(projectId);
            }
            function validateTutorSelection(projectId) {
                var tutorSelect = document.getElementById(`selected-tutor-${projectId}`);
                var selectedValue = tutorSelect.options[tutorSelect.selectedIndex].value;
                inputs_hidden(projectId);
                if (selectedValue === "all") {
                    alert("Please choose a specific tutor for the project.");   
                }
            }
        </script>
	</body>
</html>
